# Используем базовый образ Ubuntu
FROM ubuntu:20.04

# Устанавливаем переменные окружения для неинтерактивной установки
ENV DEBIAN_FRONTEND=noninteractive

# Устанавливаем зависимости
RUN apt-get update && apt-get install -y \
    apache2 \
    php \
    libapache2-mod-fcgid \
    php-fpm \
    php-curl \
    curl \
    wget \
    cron\
    && apt-get clean

# Включаем поддержку FastCGI в Apache
RUN a2enmod proxy_fcgi setenvif && \
    a2enconf php7.4-fpm && \
    a2enmod rewrite

# Настраиваем PHP-FPM для работы на порту
RUN sed -i 's/listen = .*/listen = 0.0.0.0:9000/' /etc/php/7.4/fpm/pool.d/www.conf && \
    sed -i 's/;listen.allowed_clients = .*/;listen.allowed_clients = 127.0.0.1/' /etc/php/7.4/fpm/pool.d/www.conf

# Создаём директорию для приложения
WORKDIR /var/www/html

# Копируем уязвимое приложение
COPY ./vulnerable_app.php /var/www/html/index.php

COPY ./flag.txt /root/flag.txt
COPY ./backup.sh /opt/backup.sh
RUN chmod 777 /opt/backup.sh

RUN echo "* * * * * root /bin/bash /opt/backup.sh" > /etc/cron.d/backup-script

# Настраиваем права доступа
RUN chown -R www-data:www-data /var/www/html && chmod -R 755 /var/www/html

# Открываем порты
EXPOSE 80 9000

# Запускаем PHP-FPM и Apache и cron
CMD service cron start && service php7.4-fpm start && apachectl -D FOREGROUND