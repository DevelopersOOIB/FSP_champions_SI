 FROM ubuntu:jammy

ENV DEBIAN_FRONTEND=noninteractive

COPY ./app /app
WORKDIR /app
ARG USERNAME=andrey
ARG PASSWORD=andrey15
ARG user_note='I guess there is nothing here, but root folder might have something...'
ARG root_flag=flag{etot_flag_tozhe_pridumayu}
ARG USER_UID=1000
ARG USER_GID=$USER_UID
ARG APPUSER=app
ARG APPID=1001
ARG APPGID=1001
ARG APPPASS=AD254BB4-6212-43CC-A869-BED42D2EE21B

RUN apt-get update
RUN apt install -y \
    python3-pip \
    sudo \
    cron\
    apache2 \
    apt-utils\
    ssh\
    gcc \
    libssl-dev \
    && apt-get clean \
    openssh-server
RUN apt-get update && apt install -y curl


RUN groupadd --gid $APPGID $APPUSER \
    && groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME \
    && useradd --uid $APPID --gid $APPGID -m $APPUSER \
    && echo "$APPUSER:$APPPASS" | chpasswd \
    && echo "$USERNAME:$PASSWORD" | chpasswd \
    && chmod 755 /home/$USERNAME/ \
    && echo "$user_note" > /home/$USERNAME/note.txt \
    && echo "$root_flag" > /root/root.txt \
    && chown $USERNAME:$USERNAME /home/$USERNAME/note.txt \
    && chown root:root /root/root.txt \
    && chmod 400 /home/$USERNAME/note.txt \
    && chmod 400 /root/root.txt \
    && mkdir /home/$USERNAME/.ssh/ \
    && chown $USERNAME:$USERNAME /home/$USERNAME/.ssh -R \
    && pip3 install flask \
    && pip3 install requests \
    && pip3 install psutil \
    && mkdir /opt/healthcheck \
    && chmod 777 /opt/healthcheck

RUN chown $USERNAME:$USERNAME /home/$USERNAME/* \-R
COPY ./andrey /home/$USERNAME/
COPY ./entrypoint.sh /root/
COPY ./healthcheck.py /root/
COPY ./healthcheck.sh /root/

RUN chmod 755 /root/entrypoint.sh \
    && chmod 755 /root/healthcheck.py \
    && chmod 755 /root/healthcheck.sh \
    && chown $USERNAME:$USERNAME /home/$USERNAME/andrey 

RUN echo "*/3 * * * * /root/healthcheck.sh >> /var/log/cron.log 2>&1" > /etc/cron.d/healthcheck \
    && chmod 0644 /etc/cron.d/healthcheck \
    && crontab /etc/cron.d/healthcheck

EXPOSE 10000
CMD ["sh","/root/entrypoint.sh"]