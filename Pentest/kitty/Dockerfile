FROM ubuntu:jammy

ENV DEBIAN_FRONTEND=noninteractive

RUN apt update && apt-get install -y \
    apt-utils\
    apache2 \
    ssh\
    php \
    php-mysql \
    gcc \
    libapache2-mod-php \
    libssl-dev \
    build-essential \
    make \
    && apt-get clean \
    openssh-server \
    && rm -rf /var/lib/apt/lists/* 

COPY ./event_manager_app /var/www/html

ARG USERNAME=sakura
ARG PASSWORD=th1s_p4ssw0rd_1s_s0m3th1ng
ARG user_note='I guess there is nothing here, but root folder might have something...'
ARG root_flag=flag{4D25942E-5918-4F07-9EB9-4B02B1C327E9}
ARG USER_UID=1000
ARG USER_GID=$USER_UID

RUN groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME \
    && echo "$USERNAME:$PASSWORD" | chpasswd \
    && chmod 700 /home/$USERNAME/ \
    && echo "$user_note" > /home/$USERNAME/note.txt \
    && echo "$root_flag" > /root/root.txt \
    && chown $USERNAME:$USERNAME /home/$USERNAME/note.txt \
    && chown root:root /root/root.txt \
    && chmod 400 /home/$USERNAME/note.txt \
    && chmod 400 /root/root.txt \
    && echo "ServerName localhost" >> /etc/apache2/apache2.conf \
    && a2enmod rewrite \
    && rm /var/www/html/index.html \ 
    && mkdir /home/$USERNAME/.ssh/ \
    && chown $USERNAME:$USERNAME /home/$USERNAME/.ssh -R

COPY ./sudo1.18 /sudo
RUN cd /sudo && chmod +x configure && ./configure && make && make install && rm -rf /sudo

RUN chown -R www-data:www-data /var/www/html/ \
    && chown $USERNAME:$USERNAME /home/$USERNAME/* \-R \
    && chown $USERNAME:$USERNAME $(which awk) \
    && chmod +s $(which awk)

COPY ./entrypoint.sh /
RUN chmod 755 /entrypoint.sh && \
    echo "$USERNAME ALL=(ALL,!root) NOPASSWD: /bin/bash" >> /etc/sudoers

ENTRYPOINT ["sh","/entrypoint.sh"]