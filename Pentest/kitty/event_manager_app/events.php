<?php
session_start();
error_reporting(E_ALL);
ini_set('display_errors', 1);

include 'db.php';

if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

$stmt = $conn->prepare("SELECT * FROM events WHERE user_id = ?");
$stmt->bind_param("i", $_SESSION['user_id']);
$stmt->execute();
$result = $stmt->get_result();
$events = $result->fetch_all(MYSQLI_ASSOC);
$stmt->close();

$message = '';

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['create'])) {
        $title = $_POST['title'];
        $description = $_POST['description'];
        $event_date = $_POST['event_date'];
        $location = $_POST['location'];

        $stmt = $conn->prepare("INSERT INTO events (title, description, event_date, location, user_id) VALUES (?, ?, ?, ?, ?)");
        $stmt->bind_param("ssssi", $title, $description, $event_date, $location, $_SESSION['user_id']);
        if ($stmt->execute()) {
            $message = 'Successfully created the event!';
        } else {
            $message = "Error creating event: " . htmlspecialchars($stmt->error);
        }
        $stmt->close();
    } elseif (isset($_POST['delete'])) {
        // Delete event
        $event_id = $_POST['event_id'];
        $stmt = $conn->prepare("DELETE FROM events WHERE id = ? AND user_id = ?");
        $stmt->bind_param("ii", $event_id, $_SESSION['user_id']);
        $stmt->execute();
        $stmt->close();
    } elseif (isset($_POST['edit'])) {
        // Edi can be added here
    }
}
?>

    <?php include 'templates/header.php'; ?>

    <h2>Your Events</h2>
    <form method="POST">
        <input type="text" name="title" required placeholder="Event Title">
        <textarea name="description" placeholder="Event Description"></textarea>
        <input type="datetime-local" name="event_date" required>
        <input type="text" name="location" placeholder="Location">
        <button type="submit" name="create">Create Event</button>
    </form>

    <?php if ($message): ?>
        <p style="color: green; text-align: center;"><?php echo htmlspecialchars($message); ?></p>
    <?php endif; ?>

    <h3>Upcoming Events</h3>
    <div class="event-grid">
        <?php foreach ($events as $event): ?>
            <div class="event-card">
                <h4><?php echo htmlspecialchars($event['title']); ?></h4>
                <p><strong>Date:</strong> <?php echo htmlspecialchars($event['event_date']); ?></p>
                <p><strong>Location:</strong> <?php echo htmlspecialchars($event['location']); ?></p>
                <div class="event-actions">
                    <form method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this event?');">
                        <input type="hidden" name="event_id" value="<?php echo $event['id']; ?>">
                        <button type="submit" name="delete" class="event-button">Delete</button>
                    </form>
                    <button onclick="editEvent(<?php echo $event['id']; ?>, '<?php echo htmlspecialchars($event['title']); ?>', '<?php echo htmlspecialchars($event['description']); ?>', '<?php echo htmlspecialchars($event['event_date']); ?>', '<?php echo htmlspecialchars($event['location']); ?>')" class="event-button">Edit</button>
                </div>
            </div>
        <?php endforeach; ?>
    </div>

    <div id="editModal" style="display:none;">
        <form id="editForm" method="POST">
            <input type="hidden" name="event_id" id="editEventId">
            <input type="text" name="title" id="editTitle" required placeholder="Event Title">
            <textarea name="description" id="editDescription" placeholder="Event Description"></textarea>
            <input type="datetime-local" name="event_date" id="editEventDate" required>
            <input type="text" name="location" id="editLocation" placeholder="Location">
            <button type="submit" name="edit" class="event-button">Update Event</button>
            <button type="button" onclick="closeEditModal()" class="event-button">Cancel</button>
        </form>
    </div>

    <script>
        function editEvent(id, title, description, eventDate, location) {
            document.getElementById('editEventId').value = id;
            document.getElementById('editTitle').value = title;
            document.getElementById('editDescription').value = description;
            document.getElementById('editEventDate').value = eventDate;
            document.getElementById('editLocation').value = location;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
    </script>
        <?php include 'templates/footer.php'; ?>
</body>
</html>